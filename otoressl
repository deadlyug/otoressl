#!/bin/bash
source ./config

validDay=$(certbot certificates | grep Expiry | awk '{print $6}')
if [[ $validDay < 30 ]]; then
  curl -s -X POST https://api.telegram.org/bot${TOKEN_BOT_TELEGRAM}/sendMessage -d chat_id=${ID_BOT_TELEGRAM} -d text="NOTIF SSL @$(cat /etc/hostname)

Renewing certificate..
"
  echo "Renewing certificate.."
  if $(which certbot) renew; then
    curl -s -X POST https://api.telegram.org/bot${TOKEN_BOT_TELEGRAM}/sendMessage -d chat_id=${ID_BOT_TELEGRAM} -d text="NOTIF SSL

Success! certificate renewed..
menghitung hari untuk dibuatkan cronjob/automatic renew certificate...
"

    echo "Success! certificate renewed..
menghitung hari untuk dibuatkan cronjob/automatic renew certificate...
"
  fi
else
  echo "belum memasuki waktu yang pas untuk renew certificate"
  echo "menghitung hari untuk dibuatkan cronjob/automatic renew certificate..."
fi

isCrontab=$(which crontab)
OS=$(hostnamectl | grep "Operating System" | awk '{print $3}')

if [[ $isCrontab == "" ]]; then
  
  case $OS in
    "Arch")
      sudo pacman -Syyy cronie
      systemctl enable --now cronie
      ;;
    "Ubuntu")
      apt-get update && apt-get install cron
      systemctl enable --now cron
      ;;
    "CentOS")
      yum update && yum install cronie
      systemctl enable --now cronie
      ;;
  esac
  
fi

crontab -l | sed 's/.*certbot.*//' | crontab -
crontab -l | sed '/^$/d'| crontab -

renewDay="$(($validDay - 10))"

month=$(date --date="+$renewDay days" +%-m)
day=$(date --date="+$renewDay days" +%-d)

{ crontab -l; echo "0 9 $day $month * source $(pwd)/otoressl"; } | crontab -
